# This script was generated by Christian D. Huber (Department of Biology, The Eberly College of Science, Penn State University, State College, PA 16801, USA)
# and Raymond Tobler (School of Biological Sciences, University of Adelaide)

library(ggplot2)
library(data.table)
library(foreach)

# Basic theoretical predictions of selection from SGV vs de novo mutation.

# Functions

#Equation 11 in Soft Sweeps: Molecular Population Genetics of Adaptation From Standing Genetic Variation
#probability of fixation from de novo mutation, given a certain time period of g generations
#adjusted for bottleneck (or set B=1 of constant size)
#Ne is current Ne
p.denovo <- function(Ne, mu, L, s.b, h.b, g){
  G <- g/(2*Ne)
  theta <- 4*Ne*mu*L
  alpha.b <- 2*Ne*s.b
  a <- 1 - exp(-theta*h.b*alpha.b*G)
  return(data.frame(G=G, theta=theta, R=NA, p=a))
}

#Equation 8 in Soft Sweeps: Molecular Population Genetics of Adaptation From Standing Genetic Variation
#probability of fixation from SGV
#adjusted for bottleneck (or set B=1 of constant size)
#Ne is ancestral Ne
p.sgv <- function(B, Ne, mu, L, s.d, s.b, h.d, h.b){
  theta <- 4*Ne*mu*L
  alpha.d <- 2*Ne*s.d
  alpha.b <- 2*Ne*s.b
  R <- (2*h.b*alpha.b) / (2*h.d*alpha.d + 1)
  a <- 1 - exp(-theta*log(1 + R/B))
  return(data.frame(G=NA, theta=theta, R=R, p=a))
}

#Equation 14 in Soft Sweeps: Molecular Population Genetics of Adaptation From Standing Genetic Variation
#given fixation of allele, the probability of sgv fixation relative to de novo
#adjusted for bottleneck (or set B=1 of constant size)
p.sgv.fix.bot <- function(B, Ne, mu, L, s.d, s.b, h.d, h.b, g){
  G <- g/(2*Ne)
  theta <- 4*Ne*mu*L
  alpha.d <- 2*Ne*s.d
  alpha.b <- 2*Ne*s.b
  R <- (2*h.b*alpha.b) / (2*h.d*alpha.d + 1)
  a <- 1 - exp(-theta*log(1 + R/B))
  b <- 1 - exp(-theta*(log(1 + R/B) + h.b*alpha.b*G/B))
  return(data.frame(G=G, theta=theta, R=R, p=a/b))
}


#Equation 18 in Soft Sweeps: Molecular Population Genetics of Adaptation From Standing Genetic Variation
#given fixation from sgv, the probability that multiple copies fix
#adjusted for bottleneck (or set B=1 of constant size)
p.multi.sgv.fix.bot <- function(B, Ne, mu, L, s.d, s.b, h.d, h.b){
  theta <- 4*Ne*mu*L
  alpha.d <- 2*Ne*s.d
  alpha.b <- 2*Ne*s.b
  R <- (2*h.b*alpha.b) / (2*h.d*alpha.d + 1)
  a <- theta*(R/B)/(1 + R/B)
  b <- (1 + R/B)^theta - 1
  return(data.frame(theta=theta, R=R, p=1-(a/b)))
}

#Equation 20 in Soft Sweeps: Molecular Population Genetics of Adaptation From Standing Genetic Variation
#given fixation from sgv, the probability that multiple independent copies fix (i.e. how soft is the sweep)
#adjusted for bottleneck (or set B=1 of constant size)
p.ind.sgv.fix.bot <- function(B, Ne, mu, L, s.d, s.b, h.d, h.b){
  theta <- 4*Ne*mu*L
  alpha.d <- 2*Ne*s.d
  alpha.b <- 2*Ne*s.b
  R <- (2*h.b*alpha.b) / (2*h.d*alpha.d + 1)
  a <- theta*log(1 + R/B)
  b <- (1 + R/B)^theta - 1
  return(data.frame(theta=theta, R=R, p=1-(a/b)))
}


# Computing probabilities

mu <- 3e-8  # mutation rate
g <- 30     # Num. of generations with selection
L <- 7      # Mutational target size
sgv.mat <- foreach(s.b=(1:100)/100, .combine=rbind) %do% {   # beneficial selection coefficient
  foreach(ne.anc=c(42, 84)*1000, .combine=rbind) %do% {      # ancestral population size
    foreach(s.d=c(10^-(3:4), 0), .combine=rbind)  %do% {     # deleterious selection coefficient
      
      ne <- ne.anc   # Assume current population size is the same as ancestral population size
      bot <- ne.anc/ne  # i.e. no bottleneck, bot=1
      
      print(paste(s.b, s.d, g, ne, ne.anc, L))
      
      denovo.prob <- p.denovo(Ne=ne, mu=mu, L=L, 
                        s.b=s.b, h.b=0.5, g = g)
      sgv.prob <- p.sgv(B=bot, Ne=ne.anc, mu=mu, L=L, 
                               s.d=s.d, s.b=s.b, h.b=0.5, h.d=0.5)
      sgv.fix <- p.sgv.fix.bot(B=bot, Ne=ne.anc, mu=mu, L=L, 
                               s.d=s.d, s.b=s.b, h.b=0.5, h.d=0.5, g=g)
      sgv.mult.fix <- p.multi.sgv.fix.bot(B=bot, Ne=ne.anc, mu=mu, L=L, 
                                          s.d=s.d, s.b=s.b, h.b=0.5, h.d=0.5)
      sgv.ind.fix <- p.ind.sgv.fix.bot(B=bot, Ne=ne.anc, mu=mu, L=L,
                                       s.d=s.d, s.b=s.b, h.b=0.5, h.d=0.5)
      data.table(Ne.sel=ne, Ne.anc=ne.anc, g=g, s.b=s.b, s.d=s.d, Mut.target=L, 
                 p.sgv = sgv.prob$p, p.denovo = denovo.prob$p, p.sgv.fix=sgv.fix$p, p.mult.sgv.fix=sgv.mult.fix$p, p.ind.sgv.fix=sgv.ind.fix$p)
    }
  }
}


sgv.mat[, Ne_anc := paste0("Ne=", Ne.anc, "")]

## Plots

p1= ggplot(sgv.mat, aes(s.b, p.sgv, col=factor(s.d))) + geom_line(size=1) + facet_grid(.~factor(Ne_anc)) + 
  coord_cartesian(ylim=c(0,1)) + theme_light() +
  scale_color_manual(values=c("#206040","#339966", "#79d2a6")) + labs(x="s.ben", y="P(sweep from SGV)", col="s.del") + 
  theme(text=element_text(size=20))
p1
 
png("Sweep_SGV.png", width = 300, height = 150, units='mm', res = 300)
p1
dev.off()

p2 = ggplot(sgv.mat, aes(s.b, p.sgv.fix, col=factor(s.d))) + geom_line(size=1) + facet_grid(.~factor(Ne_anc)) + 
  coord_cartesian(ylim=c(0,1)) + theme_light() +
  scale_color_manual(values=c("#206040","#339966", "#79d2a6")) + labs(x="s.ben", y="P(sweep from SGV | sweep)", col="s.del") +
  theme(text=element_text(size=20))
p2

png("Sweep_SGV_vs_sweep.png", width = 300, height = 150, units='mm', res = 300)
p2
dev.off()

p3 = ggplot(sgv.mat, aes(s.b, p.sgv + p.denovo - p.sgv*p.denovo, col=factor(s.d))) + geom_line(size=1) + facet_grid(.~factor(Ne_anc)) + 
  coord_cartesian(ylim=c(0,1)) + theme_light() +
  scale_color_manual(values=c("#206040","#339966", "#79d2a6")) + labs(x="s.ben", y="P(sweep)", col="s.del") + 
  theme(text=element_text(size=20))
p3

png("Sweep.png", width = 300, height = 150, units='mm', res = 300)
p3
dev.off()


